<html>
    <head>
        <title>SetLocalStorage</title>
    </head>
    <body>
        <p id="texts">Setting...</p>
        <script>
            const txt = document.getElementById("texts");
            const url = new URL(window.location.href);
            const data = url.searchParams.get("data");
            const dest = url.searchParams.get("for");
            const uinfo = url.searchParams.get("name");
            if(!data || !dest || !uinfo){
                console.error("Missing info.");
                txt.innerText = "Invalid. Nothing was set."
                setTimeout(endSession, 1000);
            } else {
                if (dest === "discord_btoa"){
                    const tempdata = JSON.parse(atob(data));
                    if (uinfo == tempdata.username){
                        txt.innerText = "Set!";
                    localStorage.setItem("testUserData", data);
                    localStorage.setItem("testUserDataName", uinfo);
                    } else {
                        console.warn("U: "+ uinfo + "\nTU: "+ tempdata.username)
                        txt.innerText = "Invalid. Nothing was set."
                        setTimeout(endSession, 1000);
                    };
                };
                 if (dest === "nspx"){
                    
                    console.warn("U: "+ uinfo + "\nD: "+ data);
                    const response = await validateData(data);
                    if (response){
                        console.log("It's valid.")
                    const checker = localStorage.getItem("nspx.isChecking");
                    localStorage.setItem("nspx.data", data);
                    localStorage.setItem("nspx.user", uinfo);
                    txt.innerText = "Set!";
                    } else {
                        
                        txt.innerText = "Invalid. Nothing was set."
                        setTimeout(endSession, 1000);
                    };
                };
                
                endSession();
            };

           async function validateData(data){
            const postData = {data: data}
                try {
                    const response = fetch(`https://nspx-form.gbp.workers.dev/login/aes/validate`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json' 
  },
  body: JSON.stringify(postData) 
});
                    if (!response.ok) throw new Error('Not valid');
                    return await response.json();
                } catch (error) {
                    throw error;
                }
            };
            function endSession(){
                debugger; // pause to see setloc errors
                document.close();
                window.close();
                window.location.href = "https://" + document.domain;
            }
        </script>
    </body>
</html>